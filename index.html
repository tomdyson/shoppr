<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b1de">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Shoppr</title>
    <link rel="manifest" href="/manifest.json">
    <link href="/dist/output.css" rel="stylesheet">
    <link rel="preload" href="/paris-figure-down.jpg" as="image">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
    <style>
        /* Item styling similar to Todonanny task-item */
        .item-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }

        .item-row input[type="checkbox"] {
            cursor: pointer;
            margin-top: 0.2rem;
        }

        .item-row span {
            transition: all 0.3s ease;
        }

        /* Image container transitions like Todonanny */
        .image-container {
            transition: width 0.5s ease-in-out;
        }

        .image-container img {
            transition: all 0.5s ease-in-out;
            height: auto;
        }

        /* Rose highlight for selected items */
        .item-row.bg-rose-400 {
            background-color: rgb(251 113 133);
        }

        kbd {
            font-family: ui-monospace, monospace;
            border: 1px solid #e2e8f0;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(6, 177, 222, 0.2);
            border-top-color: #06b1de;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Hide camera button on desktop */
        @media (hover: hover) {
            .camera-btn {
                display: none;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            #app {
                max-width: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .shopping-list {
                background-color: transparent !important;
                color: black !important;
                padding: 0 !important;
            }

            .group-header {
                color: black !important;
                font-weight: bold;
                font-size: 1.1em;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                border-bottom: 1px solid #000;
                page-break-after: avoid;
            }

            .item-row {
                background-color: transparent !important;
                border-bottom: 1px solid #eee;
                padding-left: 0;
                page-break-inside: avoid;
            }

            .item-row input[type="checkbox"] {
                border: 1px solid black;
                accent-color: black;
                filter: grayscale(100%);
            }

            .item-row span {
                color: black !important;
            }

            /* Explicitly cross out checked items in print mode, bypassing Tailwind if needed */
            .item-row input[type="checkbox"]:checked+span,
            .item-row .line-through {
                text-decoration: line-through !important;
                text-decoration-color: black !important;
            }

            .item-row .text-rose-100 {
                color: black !important;
            }
        }
    </style>
</head>

<body class="flex justify-center min-h-screen pt-6 font-mono text-slate-700">
    <div id="app" class="max-w-screen-md mx-auto w-full p-4 bg-white flex flex-col lg:flex-row">
        <!-- Image column - smaller when viewing list -->
        <div class="image-container w-full lg:w-1/5 p-4 pb-0 lg:pb-4 no-print" v-if="isViewMode">
            <img :src="figureImage" alt="Paris" class="w-24 lg:w-full">
        </div>
        <div class="image-container w-full lg:w-1/3 p-4 pb-0 lg:pb-4 no-print" v-else>
            <img src="/paris-figure.jpg" alt="Paris" class="w-24 lg:w-full">
        </div>

        <!-- Main content column -->
        <div class="w-full lg:w-3/4 p-4 space-y-4">
            <!-- Input Mode -->
            <form @submit.prevent="processInput" v-if="!isViewMode">
                <div class="flex justify-between items-center mb-3 mt-3">
                </div>

                <!-- Supermarket selector -->
                <div class="mb-4">
                    <select id="supermarket" v-model="selectedSupermarket"
                        class="text-lg font-light font-mono border border-gray-300 px-2 py-1 mb-1 w-full rounded">
                        <option value="">Any supermarket</option>
                        <option v-for="(name, key) in supermarkets" :key="key" :value="key">{{ name }}</option>
                    </select>
                </div>

                <!-- Text input -->
                <textarea id="listInput" v-model="inputText" rows="4"
                    class="text-lg font-light border border-gray-300 px-2 py-1 mb-1 w-full rounded resize-none overflow-hidden min-h-[100px] leading-[1.5]"
                    placeholder="Paste or type your shopping list here..."></textarea>

                <!-- Image upload area -->
                <div class="my-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center"
                        :class="{ 'border-cyan-400 bg-cyan-50': isDragging }" @dragover.prevent="isDragging = true"
                        @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop">

                        <!-- Image preview -->
                        <div v-if="imagePreview" class="mb-2">
                            <img :src="imagePreview" class="max-h-32 mx-auto rounded shadow">
                            <button type="button" @click="clearImage"
                                class="mt-2 text-sm text-rose-500 hover:text-rose-700">
                                Remove image
                            </button>
                        </div>

                        <!-- Upload buttons -->
                        <div v-else class="text-sm text-slate-500">
                            <p class="mb-2">Or upload an image</p>
                            <div class="flex justify-center gap-2 flex-wrap">
                                <label class="cursor-pointer px-3 py-1 bg-slate-100 rounded hover:bg-slate-200">
                                    Choose file
                                    <input type="file" accept="image/*" @change="handleFileSelect" class="hidden">
                                </label>
                                <label
                                    class="camera-btn cursor-pointer px-3 py-1 bg-slate-100 rounded hover:bg-slate-200">
                                    Take photo
                                    <input type="file" accept="image/*" capture="environment" @change="handleFileSelect"
                                        class="hidden">
                                </label>
                                <button type="button" @click="pasteFromClipboard"
                                    class="px-3 py-1 bg-slate-100 rounded hover:bg-slate-200">
                                    Paste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit button -->
                <input id="submit"
                    class="hover:opacity-75 mt-3 cursor-pointer bg-cyan-100 px-2 py-1 font-light rounded text-lg mb-1 disabled:opacity-50 disabled:cursor-not-allowed"
                    type="submit" :value="isLoading ? loadingMessage : 'Create shopping list'"
                    :disabled="isLoading || (!inputText.trim() && !imageData)" />

                <!-- Error message -->
                <div v-if="errorMessage" class="mt-4 p-2 bg-rose-100 text-rose-600 rounded text-sm">
                    {{ errorMessage }}
                </div>
            </form>

            <!-- View Mode (Shopping List) -->
            <div v-if="isViewMode">
                <!-- Progress info -->
                <div class="text-sm text-slate-500 mb-2 no-print" v-if="supermarketDisplay">
                    {{ supermarketDisplay }}
                </div>

                <!-- Shopping list items grouped by area -->
                <div v-if="groups.length"
                    class="shopping-list my-3 text-lg font-mono text-white bg-rose-300 pt-2 px-2 pb-1 rounded leading-normal">
                    <div v-for="group in groups" :key="group.area" class="mb-4">
                        <div class="group-header text-sm text-rose-100 uppercase tracking-wide mb-1">{{
                            group.area_display }}</div>
                        <div v-for="item in group.items" :key="item.id" class="item-row"
                            :class="{'bg-rose-400': item.id === selectedItemId }"
                            @click="selectedItemId = item.id">
                            <input type="checkbox" :id="'item-' + item.id" :checked="item.checked"
                                @change="toggleItem(item)"
                                class="mr-2 h-4 w-4 rounded border-gray-300 text-rose-400 focus:ring-rose-300 cursor-pointer">
                            <span :class="{'line-through': item.checked }" class="leading-tight">
                                <div>{{ item.name }}<span v-if="item.quantity" class="text-rose-100 text-sm ml-1">({{
                                        item.quantity }})</span></div>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Progress display -->
                <div id="context" v-if="totalCount > 0"
                    class="no-print text-lg pt-2 px-2 pb-1 rounded leading-normal bg-cyan-100 text-cyan-600">
                    {{ checkedCount }} of {{ totalCount }} items checked
                </div>

                <!-- All done message -->
                <div v-if="checkedCount === totalCount && totalCount > 0"
                    class="no-print text-lg bg-green-200 font-mono pt-2 px-2 pb-1 rounded leading-normal mt-4">
                    All done! Shopping complete.
                </div>

                <!-- Action buttons -->
                <div class="flex space-x-2 mt-4 no-print">
                    <a :href="'/' + listId + '.pdf'" target="_blank"
                        class="hover:opacity-75 cursor-pointer bg-slate-100 px-2 py-1 font-light rounded text-lg text-slate-700 no-underline">
                        Print
                    </a>
                    <button @click="shareList"
                        class="hover:opacity-75 cursor-pointer bg-green-100 px-2 py-1 font-light rounded text-lg">
                        Share
                    </button>
                    <a href="/" @click.prevent="newList"
                        class="hover:opacity-75 cursor-pointer bg-cyan-100 px-2 py-1 font-light rounded text-lg">
                        New list
                    </a>
                </div>

                <!-- LLM Token Usage Footer (Debug) -->
                <div v-if="meta" class="mt-6 no-print" style="font-size: 11px; color: #94a3b8;">
                    <button @click="showDebug = !showDebug" class="hover:underline">
                        {{ showDebug ? 'Hide' : 'Show' }} debug info
                    </button>
                    <div v-if="showDebug" class="mt-2">
                        <div v-if="meta.ocr" class="mb-2">
                            <div class="font-semibold" style="color: #64748b;">Image Recognition</div>
                            <div>Model: {{ meta.ocr.model }}</div>
                            <div>Tokens: {{ meta.ocr.input_tokens }} in, {{ meta.ocr.output_tokens }} out</div>
                            <div>Cost: ${{ formatCost(meta.ocr.cost) }}</div>
                        </div>
                        <div v-if="meta.planning">
                            <div class="font-semibold" style="color: #64748b;">Shopping List Planning</div>
                            <div>Model: {{ meta.planning.model }}</div>
                            <div>Tokens: {{ meta.planning.input_tokens }} in, {{ meta.planning.output_tokens }} out</div>
                            <div>Cost: ${{ formatCost(meta.planning.cost) }}</div>
                        </div>
                        <div v-if="totalCost > 0" class="mt-2 font-semibold border-t border-slate-100 pt-1" style="color: #64748b;">
                            Total Estimated Cost: ${{ formatCost(totalCost) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help button -->
        <div class="fixed bottom-4 left-4 no-print">
            <button @click="showHelp = !showHelp"
                class="w-8 h-8 rounded-full bg-slate-200 hover:bg-slate-300 flex items-center justify-center text-slate-600">
                ?
            </button>
        </div>

        <!-- Help overlay -->
        <div v-if="showHelp"
            class="fixed bottom-16 left-4 p-4 bg-white shadow-lg rounded-lg border border-slate-200 max-w-sm no-print">
            <h3 class="font-bold mb-2">How to Use</h3>
            <div class="text-sm space-y-2">
                <p>Type or paste your shopping list, or upload an image of a list.</p>
                <p class="bg-slate-50 p-2 rounded italic">
                    e.g. Milk 2L, Bread, 6 eggs, Chicken breast 500g
                </p>
                <p>The app will organize items by supermarket section.</p>
            </div>
        </div>

        <!-- Share Modal -->
        <div v-if="showShareModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 no-print">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h3 class="font-bold mb-4">Share your list</h3>
                <input type="text" ref="shareUrl" :value="shareUrl" class="w-full p-2 border rounded mb-4 bg-slate-50"
                    readonly @click="$refs.shareUrl.select()">
                <div class="flex justify-end space-x-2">
                    <button @click="showShareModal = false" class="px-4 py-2 rounded hover:opacity-75 bg-slate-100">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                // Input state
                inputText: '',
                selectedSupermarket: '',
                imagePreview: null,
                imageData: null,
                isDragging: false,

                // UI state
                isLoading: false,
                loadingMessage: '',
                isViewMode: false,
                showShareModal: false,
                showHelp: false,
                showDebug: false,
                errorMessage: '',
                selectedItemId: null,

                // List data
                listId: null,
                supermarket: null,
                supermarketDisplay: null,
                groups: [],
                meta: null,

                // Supermarket options
                supermarkets: {
                    tesco: 'Tesco',
                    sainsburys: "Sainsbury's",
                    asda: 'Asda',
                    morrisons: 'Morrisons',
                    aldi: 'Aldi',
                    lidl: 'Lidl',
                    waitrose: 'Waitrose',
                    ms: 'M&S'
                }
            },
            computed: {
                totalCount() {
                    return this.groups.reduce((sum, g) => sum + g.items.length, 0);
                },
                checkedCount() {
                    return this.groups.reduce((sum, g) =>
                        sum + g.items.filter(i => i.checked).length, 0);
                },
                progressPercent() {
                    if (this.totalCount === 0) return 0;
                    return Math.round((this.checkedCount / this.totalCount) * 100);
                },
                shareUrl() {
                    return window.location.href;
                },
                totalCost() {
                    let cost = 0;
                    if (this.meta) {
                        if (this.meta.ocr) cost += this.meta.ocr.cost;
                        if (this.meta.planning) cost += this.meta.planning.cost;
                    }
                    return cost;
                },
                selectedItemPosition() {
                    if (!this.selectedItemId) return 0;
                    let position = 0;
                    for (const group of this.groups) {
                        for (const item of group.items) {
                            position++;
                            if (item.id === this.selectedItemId) {
                                return position;
                            }
                        }
                    }
                    return 0;
                },
                figureImage() {
                    return this.selectedItemPosition > 3 ? '/paris-figure-down.jpg' : '/paris-figure.jpg';
                }
            },
            methods: {
                formatCost(val) {
                    if (val === undefined || val === null) return '0.00000';
                    return val.toFixed(5);
                },
                async processInput() {
                    this.errorMessage = '';
                    this.isLoading = true;

                    try {
                        let response;

                        if (this.imageData) {
                            this.loadingMessage = 'Processing image...';
                            response = await fetch('/api/process-image', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    image: this.imageData,
                                    supermarket: this.selectedSupermarket || null
                                })
                            });
                        } else {
                            this.loadingMessage = 'Creating list...';
                            response = await fetch('/api/process', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    text: this.inputText,
                                    supermarket: this.selectedSupermarket || null
                                })
                            });
                        }

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Failed to process input');
                        }

                        const data = await response.json();
                        this.showList(data);

                    } catch (error) {
                        console.error('Error:', error);
                        this.errorMessage = error.message || 'Something went wrong. Please try again.';
                    } finally {
                        this.isLoading = false;
                        this.loadingMessage = '';
                    }
                },

                showList(data) {
                    this.listId = data.list_id;
                    this.supermarket = data.supermarket;
                    this.supermarketDisplay = data.supermarket_display;
                    this.groups = data.groups;
                    this.meta = data.meta || null;
                    this.isViewMode = true;

                    // Select first unchecked item
                    for (const group of this.groups) {
                        const unchecked = group.items.find(i => !i.checked);
                        if (unchecked) {
                            this.selectedItemId = unchecked.id;
                            break;
                        }
                    }

                    // Update URL
                    window.history.pushState({}, '', `/${data.list_id}`);
                },

                async loadList(listId) {
                    try {
                        const response = await fetch(`/api/list/${listId}`);
                        if (!response.ok) {
                            throw new Error('List not found');
                        }
                        const data = await response.json();
                        this.showList(data);
                    } catch (error) {
                        console.error('Error loading list:', error);
                        // Redirect to home if list not found
                        window.history.pushState({}, '', '/');
                    }
                },

                async toggleItem(item) {
                    item.checked = !item.checked;

                    try {
                        await fetch(`/api/list/${this.listId}/item/${item.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ checked: item.checked })
                        });
                    } catch (error) {
                        // Revert on failure
                        item.checked = !item.checked;
                        console.error('Error updating item:', error);
                    }
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.processImageFile(file);
                    }
                },

                handleDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.processImageFile(file);
                    }
                },

                async pasteFromClipboard() {
                    try {
                        const clipboardItems = await navigator.clipboard.read();
                        for (const item of clipboardItems) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    const blob = await item.getType(type);
                                    this.processImageFile(blob);
                                    return;
                                }
                            }
                        }
                        this.errorMessage = 'No image found in clipboard';
                    } catch (error) {
                        console.error('Clipboard error:', error);
                        this.errorMessage = 'Could not read from clipboard. Try using Ctrl+V.';
                    }
                },

                processImageFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.imagePreview = e.target.result;
                        this.imageData = e.target.result;
                        this.inputText = ''; // Clear text if image is added
                    };
                    reader.readAsDataURL(file);
                },

                clearImage() {
                    this.imagePreview = null;
                    this.imageData = null;
                },

                shareList() {
                    navigator.clipboard.writeText(window.location.href)
                        .then(() => {
                            this.showShareModal = true;
                            this.$nextTick(() => {
                                this.$refs.shareUrl.select();
                            });
                        })
                        .catch(err => {
                            console.error('Failed to copy:', err);
                        });
                },

                newList() {
                    this.isViewMode = false;
                    this.listId = null;
                    this.groups = [];
                    this.meta = null;
                    this.inputText = '';
                    this.imagePreview = null;
                    this.imageData = null;
                    this.selectedSupermarket = '';
                    this.errorMessage = '';
                    this.selectedItemId = null;
                    window.history.pushState({}, '', '/');
                },

                handleKeyboard(e) {
                    // Handle '?' key
                    if (e.key === '?') {
                        e.preventDefault();
                        this.showHelp = !this.showHelp;
                        return;
                    }

                    // Handle escape key for modals
                    if (e.key === 'Escape') {
                        if (this.showShareModal) {
                            this.showShareModal = false;
                        }
                        if (this.showHelp) {
                            this.showHelp = false;
                        }
                        return;
                    }
                }
            },
            mounted() {
                // Check if we're on a list page (5-char alphanumeric slug)
                const path = window.location.pathname;
                const match = path.match(/^\/([a-z0-9]{5})$/);
                if (match) {
                    this.loadList(match[1]);
                }

                // Handle paste event globally
                document.addEventListener('paste', (e) => {
                    if (this.isViewMode) return;

                    const items = e.clipboardData.items;
                    for (const item of items) {
                        if (item.type.startsWith('image/')) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            this.processImageFile(file);
                            break;
                        }
                    }
                });

                // Add keyboard event listener
                window.addEventListener('keydown', this.handleKeyboard);
            },
            destroyed() {
                window.removeEventListener('keydown', this.handleKeyboard);
            }
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>

</html>